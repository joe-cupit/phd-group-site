---
import { getCollection } from "astro:content";

interface Props {
  filterAuthor?: string;
  year?: number;
  sortBy?: "date" | "title";
  limit?: number;
}

const {
  filterAuthor,
  year,
  sortBy = "date",
  limit,
} = Astro.props;

let items = await getCollection("publications");
if (year) {
  items = items.filter((p) => p.data.date.getFullYear() == year);
}
if (filterAuthor) {
  items = items.filter((p) => p.data.authors.includes(filterAuthor));
}
items = [...items].sort((a, b) => {
  if (sortBy === "title") {
    return a.data.title.localeCompare(b.data.title);
  }
  return a.data.date < b.data.date ? 1 : -1;
});
if (limit) {
  items = items.slice(0, limit);
}

const people = await getCollection("group");
const peopleById = Object.fromEntries(
  people.map((p) => [p.id, p])
);

const months = [
  "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
]
---

<ul class="publications">
  {items.length > 0
  ? items?.map((pub) => (
      <li>
        <p class="date">{`${months[pub.data.date.getMonth()]} ${pub.data.date.getFullYear()}`}</p>
        <div class="main">
            <p class="journal">{pub.data.journal}</p>
            <a href={pub.data.doi} target="_blank">
              <h3 class="title">{pub.data.title}</h3>
            </a>
            <p class="authors">
              {pub.data.authors.map((author, index) => {
                const person = peopleById[author];

                if (person) {
                  return (<>
                      <a href={`/group/${person.id}`} class="group-author">{person.data.name}</a>{index < pub.data.authors.length - 1 ? ", " : ""}
                  </>)
                }

                const names = author.split(" ")
                return (`${names[names.length - 1]} ${names[0][0]}.`) + (index < pub.data.authors.length - 1 ? ", " : "")
              })}
            </p>
        </div>
      </li>
    ))
  : "None"
  }
</ul>

<style>
  a {
    text-decoration: none;
    color: inherit;

    &:hover {
      color: var(--clr-primary);
    }
  }

  .publications {
    container-type: inline-size;

    list-style: none;

    display: grid;
    /* grid-template-columns: 9ch 1fr; */
    row-gap: 1.5rem;
    /* column-gap: 1ch; */
    width: 100%;

    & li {
      display: grid;
      grid-template-columns: 9ch 1fr;
      column-gap: 1ch;
    }

    & .date {
      font-style: italic;
    }

    & .title {
      font-family: var(--ff-body);
      font-weight: 600;
      font-size: 1rem;
    }
    & .authors {
      margin-block-start: 0.5rem;
    }
    & .group-author {
      font-weight: 500;

      &:hover {
        text-decoration: underline;
      }
    }
    & .journal {
      font-weight: 500;
      font-size: 0.9rem;
      line-height: 1.2;
      margin-block-start: 0.25rem;
    }
  }

  @container (max-width: 34rem) {
    .publications li {
      grid-template-columns: 1fr;
      row-gap: 0.25lh;
    }
  }
</style>